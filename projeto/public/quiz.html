<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Quiz</title>
    <link rel="stylesheet" href="./css/quiz.css">
</head>
<body>

<h1 id="tituloQuiz"></h1>

<div id="divQuiz" style="display:none;">
    <h2 id="enunciado"></h2>

    <div>
        <input type="radio" name="alternativa" id="alt1"><label id="lbl1" for="alt1"></label><br>
        <input type="radio" name="alternativa" id="alt2"><label id="lbl2" for="alt2"></label><br>
        <input type="radio" name="alternativa" id="alt3"><label id="lbl3" for="alt3"></label><br>
        <input type="radio" name="alternativa" id="alt4"><label id="lbl4" for="alt4"></label><br>
    </div>

    <button onclick="submeter()">Submeter resposta</button>
    <button onclick="proxima()">Próxima</button>

    <h3 id="status"></h3>
</div>

<button onclick="iniciarQuiz()">Iniciar</button>

<script>
let quiz = null;
let index = 0;
let acertos = 0;
let erros = 0;

async function iniciarQuiz() {
    const idUsuario = sessionStorage.ID_USUARIO;
    const resposta = await fetch(`/quiz/${idUsuario}`);
    quiz = await resposta.json();

    document.getElementById("tituloQuiz").innerText = quiz.titulo;
    document.getElementById("divQuiz").style.display = "block";
    index = 0;
    mostrarQuestao();
}

function mostrarQuestao() {
    const q = quiz.perguntas[index];

    document.getElementById("enunciado").innerText = q.enunciado;

    document.getElementById("lbl1").innerText = q.alternativas[0].texto;
    document.getElementById("lbl2").innerText = q.alternativas[1].texto;
    document.getElementById("lbl3").innerText = q.alternativas[2].texto;
    document.getElementById("lbl4").innerText = q.alternativas[3].texto;

    document.getElementById("alt1").value = q.alternativas[0].id_alternativa;
    document.getElementById("alt2").value = q.alternativas[1].id_alternativa;
    document.getElementById("alt3").value = q.alternativas[2].id_alternativa;
    document.getElementById("alt4").value = q.alternativas[3].id_alternativa;

    document.querySelectorAll("input[name='alternativa']").forEach(e => e.checked = false);

    document.getElementById("status").innerText = `Acertos: ${acertos} Erros: ${erros}`;
}

async function submeter() {
    const marcada = document.querySelector("input[name='alternativa']:checked");
    if (!marcada) return;

    const idAlternativa = Number(marcada.value);

    const q = quiz.perguntas[index];
    const alternativaCorreta = q.alternativas.find(a => a.correta == 1);

    const correta = alternativaCorreta.id_alternativa === idAlternativa;

    if (correta) acertos++;
    else erros++;

    document.getElementById("status").innerText = `Acertos: ${acertos} Erros: ${erros}`;

    await fetch("/quiz/resposta", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            idUsuario: sessionStorage.ID_USUARIO,
            idPergunta: q.id_pergunta,
            idAlternativaEscolhida: idAlternativa,
            correta: correta
        })
    });
}

function proxima() {
    index++;
    if (index >= quiz.perguntas.length) {
        document.getElementById("enunciado").innerText = `Pontuação Final: ${acertos}`;
        return;
    }
    mostrarQuestao();
}
</script>

</body>
</html>
