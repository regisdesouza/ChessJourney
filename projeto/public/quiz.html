<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Quiz | ChessJourney</title>
    <link rel="stylesheet" href="./css/quiz.css">
</head>
<body>

<div class="menuLateral">
    <h2>Painel</h2>
    <a href="./painel.html">Início</a>
    <a href="./quiz.html">Quiz</a>
    <a href="./tabuleiro.html">Desafio</a>
    <a href="./dash-usuario.html">Estatísticas</a>
</div>

<div>
    <div id="imagemQuiz">
        <img src="./assets/Chess-pana.svg" alt="Chess Quiz">
    </div>

    <h1 id="tituloQuiz">Quiz</h1>
    <p id="mensagemInicial">Carregando...</p>

    <div id="divQuiz" style="display:none;">
        <h2 id="enunciado"></h2>
        <label><input type="radio" name="alternativa" id="alt1"><span id="lbl1"></span></label><br>
        <label><input type="radio" name="alternativa" id="alt2"><span id="lbl2"></span></label><br>
        <label><input type="radio" name="alternativa" id="alt3"><span id="lbl3"></span></label><br>
        <label><input type="radio" name="alternativa" id="alt4"><span id="lbl4"></span></label><br>

        <h3 id="status"></h3>
    </div>

    <div id="divFinal" style="display:none; text-align:center;">
        <h2>Quiz Finalizado!</h2>
        <h3 id="resultadoFinal"></h3>
        <button onclick="window.location.href='painel.html'">Voltar ao Painel</button>
    </div>
</div>

<script>
var quiz = null;
var index = 0;
var acertos = 0;
var erros = 0;
var idUsuario = sessionStorage.ID_USUARIO;

function iniciarQuiz() {
    const idQuiz = sessionStorage.ID_QUIZ;
    if (!idQuiz) {
        document.getElementById("mensagemInicial").innerHTML = "Nenhum quiz selecionado!";
        return;
    }

    fetch("/quiz/fixed/" + idQuiz)
        .then(r => {
            if (!r.ok) throw new Error("Quiz não encontrado");
            return r.json();
        })
        .then(d => {
            if (!d || !d.perguntas || d.perguntas.length === 0) {
                document.getElementById("mensagemInicial").innerHTML = "Quiz vazio ou não encontrado!";
                return;
            }
            quiz = d;
            document.getElementById("tituloQuiz").innerHTML = quiz.titulo;
            document.getElementById("divQuiz").style.display = "block";
            document.getElementById("mensagemInicial").style.display = "none";
            index = 0;
            acertos = 0;
            erros = 0;
            mostrarQuestao();
        })
        .catch(() => {
            document.getElementById("mensagemInicial").innerHTML = "Erro ao carregar quiz.";
        });
}

function limparRadios() {
    for (let i = 1; i <= 4; i++) {
        const alt = document.getElementById("alt" + i);
        alt.checked = false;
        alt.disabled = false;
    }
}

function desabilitarRadios() {
    for (let i = 1; i <= 4; i++) {
        document.getElementById("alt" + i).disabled = true;
    }
}

function mostrarQuestao() {
    var q = quiz.perguntas[index];
    document.getElementById("enunciado").innerHTML =
        "Questão " + (index + 1) + " de " + quiz.perguntas.length + " — " + q.enunciado;

    for (let i = 0; i < 4; i++) {
        const input = document.getElementById("alt" + (i + 1));
        document.getElementById("lbl" + (i + 1)).innerHTML = q.alternativas[i].texto;
        input.value = q.alternativas[i].id_alternativa;
        input.onclick = () => responder(input);
    }

    limparRadios();
    document.getElementById("status").innerHTML = "Acertos: " + acertos + " | Erros: " + erros;
}

function responder(marcada) {
    if (!marcada) return;

    var q = quiz.perguntas[index];
    var idPergunta = q.id_pergunta;            
    var idAlternativa = marcada.value;

    var altCorreta = null;
    for (var i = 0; i < q.alternativas.length; i++) {
        if (q.alternativas[i].correta == 1) {
            altCorreta = q.alternativas[i].id_alternativa;
            break;
        }
    }

    if (idAlternativa == altCorreta) acertos++;
    else erros++;

    document.getElementById("status").innerHTML =
        "Acertos: " + acertos + " | Erros: " + erros;

    desabilitarRadios();
    enviarBusca(idPergunta, idAlternativa, altCorreta);
    index++;
    if (index >= quiz.perguntas.length) finalizarQuiz();
    else mostrarQuestao();
}

function enviarBusca(idPergunta, id_alternativa_escolhida, correta) {
    var idUsuario = sessionStorage.ID_USUARIO;
    if (!idUsuario) return;

    var corpo = {
        idUsuario,
        idPergunta,
        id_alternativa_escolhida,
        correta
    };

    fetch(`/quiz/enviarRespostas`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(corpo)
    })
    .then(res => {
        console.log("resposta:", res);
    })
    .catch(err => console.log("#ERRO:", err));
}

function finalizarQuiz() {
    document.getElementById("divQuiz").style.display = "none";
    document.getElementById("divFinal").style.display = "block";
    document.getElementById("resultadoFinal").innerHTML =
        "Você acertou " + acertos + " de " + quiz.perguntas.length;
}

window.onload = iniciarQuiz;
</script>

</body>
</html>
