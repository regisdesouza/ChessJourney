<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/tabuleiro.css">
    <title>ChessJourney | Mate de Philidor</title>
</head>
<body>
    <div class="menuLateral">
        <h2>Desafio</h2>
        <a href="./painel.html">Início</a>
        <a href="./tabuleiro.html">Desafio</a>
        <a href="./dash-usuario.html">Estatísticas</a>
        <button id="btnSair">Sair</button>
    </div>

    <div class="container">
        <h1 class="tituloPrincipal">Desafio: Mate de Philidor</h1>
        
        <div class="containerPrincipal">
            <div class="areaTabuleiro">
                <div id="tabuleiro"></div>
                <div class="infoJogo">
                    <h3>Status do Jogo</h3>
                    <div id="infoJogo">Vez das: Pretas</div>
                </div>
            </div>

            <div class="areaInstrucoes">
                <h3>Sequência do Mate</h3>
                <div>Dica: use o cavalo</div>

                <div class="instrucoesBox">
                    <h4>Instruções:</h4>
                    <p>Execute a sequência exata do mate de Philidor.</p>
                    <p><b>Clique na peça de origem e depois no destino.</b></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imagensXadrez = {
            "e1": "./assets/torre-preto.svg",
            "f1": "./assets/torre-preto.svg", 
            "h1": "./assets/rei-preto.svg",
            "c2": "./assets/peao-preto.svg",
            "c3": "./assets/dama-branca.svg",
            "h3": "./assets/peao-preto.svg",
            "g4": "./assets/peao-preto.svg",
            "d5": "./assets/peao-branco.svg",
            "e5": "./assets/peao-preto.svg",
            "g5": "./assets/cavalo-preto.svg",
            "a6": "./assets/peao-branco.svg",
            "c6": "./assets/peao-branco.svg",
            "e6": "./assets/dama-preto.svg",
            "b7": "./assets/peao-branco.svg",
            "g7": "./assets/peao-branco.svg",
            "h7": "./assets/peao-branco.svg",
            "e8": "./assets/torre-branca.svg",
            "f8": "./assets/torre-branca.svg",
            "h8": "./assets/rei-branca.svg"
        };

        const sequencia = [
            {de: "g5", para: "f7", desc: "29... Nf2+"},
            {de: "h8", para: "g8", desc: "30. Kg1"},
            {de: "f7", para: "h6", desc: "30... Nh3+"},
            {de: "g8", para: "h8", desc: "31. Kh1"},
            {de: "e6", para: "g8", desc: "31... Qg1+"},
            {de: "f8", para: "g8", desc: "32. Rxg1"},
            {de: "h6", para: "f7", desc: "32... Nf2#"}
        ];

        let lanceAtual = 0;
        let casaSelecionada = null;
        let reiBrancoId = "h8";

        function criarTabuleiro() {
            const tabuleiro = document.getElementById('tabuleiro');
            const letras = ['a','b','c','d','e','f','g','h'];
            for (let linha = 8; linha >= 1; linha--) {
                for (let coluna = 0; coluna < 8; coluna++) {
                    const letra = letras[coluna];
                    const nomeCasa = letra + linha;
                    const casa = document.createElement('div');
                    casa.className = (linha + coluna) % 2 === 0 ? 'casa branco' : 'casa verde';
                    casa.id = nomeCasa;
                    if (imagensXadrez[nomeCasa]) {
                        const img = document.createElement('img');
                        img.src = imagensXadrez[nomeCasa];
                        img.className = 'peca';
                        casa.appendChild(img);
                    }
                    casa.onclick = () => cliqueCasa(nomeCasa);
                    tabuleiro.appendChild(casa);
                }
            }
            atualizarDisplay();
        }

        function cliqueCasa(id) {
            if (lanceAtual >= sequencia.length) return;
            const lance = sequencia[lanceAtual];
            if (!casaSelecionada) {
                if (id === lance.de) {
                    casaSelecionada = id;
                    document.getElementById(id).style.backgroundColor = 'yellow';
                } else {
                    alert(`LANCE ERRADO! Você deve clicar em: ${lance.de} Lance correto: ${lance.desc}`);
                }
            } else {
                if (id === lance.para) {
                    moverPeca(casaSelecionada, id);
                    if (document.getElementById(id).children[0].src.includes('rei-branca')) {
                        reiBrancoId = id;
                    }
                    casaSelecionada = null;
                    lanceAtual++;
                    if (lanceAtual === 1 || lanceAtual === 3 || lanceAtual === 5 || lanceAtual === 7) {
                        const reiCasa = document.getElementById(reiBrancoId);
                        if (reiCasa) reiCasa.style.backgroundColor = 'red';
                    }
                    atualizarDisplay();
                } else {
                    alert(`LANCE ERRADO! Você deve mover para: ${lance.para} Lance correto: ${lance.desc}`);
                    restaurarCor(document.getElementById(casaSelecionada));
                    casaSelecionada = null;
                }
            }
        }

        function moverPeca(de, para) {
            const origem = document.getElementById(de);
            const destino = document.getElementById(para);
            if (destino.children.length > 0) destino.innerHTML = '';
            const peca = origem.children[0];
            destino.appendChild(peca);
            origem.innerHTML = '';
            restaurarCor(origem);
            restaurarCor(destino);
        }

        function restaurarCor(casa) {
            const id = casa.id;
            const coord = id.split('');
            const linha = Number(coord[1]);
            const coluna = 'abcdefgh'.indexOf(coord[0]);
            if ((linha + coluna) % 2 === 0) casa.style.backgroundColor = 'white';
            else casa.style.backgroundColor = '#008000';
        }

        function atualizarDisplay() {
            const info = document.getElementById('infoJogo');
            if (lanceAtual < sequencia.length) {
                const vez = sequencia[lanceAtual].de === "g5" || sequencia[lanceAtual].de === "f7" || sequencia[lanceAtual].de === "e6" || sequencia[lanceAtual].de === "h6" ? 'Pretas' : 'Brancas';
                info.innerHTML = `Vez das: ${vez}`;
            } else {
                info.innerHTML = "XEQUE-MATE! PARÁBENS!";
            }
        }

        criarTabuleiro();

        document.getElementById('btnSair').onclick = () => {
            sessionStorage.clear();
            window.location.href = "tela-login.html";
        };
    </script>
</body>
</html>
